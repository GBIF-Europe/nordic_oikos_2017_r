# Event data download and data-wrangling
Anders GravbrÃ¸t Finstad  
February 8, 2018  



## Discover event data in GBIF

## Download dwc-a from IPT

Some essential event-type data terms are currently not searchable through the GBIF API, you can use metadata search through the "datasets" call of rgbif, or search through the GBIF portal and locate the UUID of the dataset. Here, we download the data set as a DwC-A directly from the IPT using the following workflow. 

1. Use the [jsonlite package](https://cran.r-project.org/web/packages/jsonlite/vignettes/json-apis.html) to get the endpoint for the raw DwC-a representation of the dataset at the IPT installation. This takes the raw API call "http://api.gbif.org/v1/dataset/'dataset UUID'/endpoint", downloads information as JSON. This is address is can also be found by scrolling down on the dataset homepage to the [data description section](https://www.gbif.org/dataset/78360224-5493-45fd-a9a0-c336557f09c3#dataDescription)
2. Then we extract the DWC-A endpoint URL, and use the [curl package](https://cran.r-project.org/web/packages/curl/vignettes/intro.html) to download this to a temporary file 
3. We extract the event and occurrence table and join the table with the left_join command from the [dplyr package](https://cran.r-project.org/web/packages/dplyr/vignettes/dplyr.html). Note that we here remove id field id "%>% select(-id)" from the occurrence and event table respectively to avoid duplicated column names (the id field represent the eventID and occurrenceID respectively)
4. Finally, we may have a [measurmentORFact](http://rs.tdwg.org/dwc/terms/#MeasurementOrFact) (MOF) table attached. This is a generic way of attaching no-dwc terms like measurements, traits etc. to the data ([description](https://tools.gbif.org/dwca-validator/extension.do?id=dwc:MeasurementOrFact)), and is in a [long dataformat](https://sejdemyr.github.io/r-tutorials/basics/wide-and-long/). When attached to an event-core DwC-A this always has an ID corresponding to the eventID (core file). Likewise, when attached to an occurrence-core DwC-A the ID field corresponds to the occurrence core-table of the DWC-A. There are also a new type in use a type called extendedMeasurmentsOrFact (eMOF) which is able to hold measures linked to both event and occurrence tables ([description](http://www.iobis.org/manual/dataformat/)). Usage is otherwise more or less similar. The MOF (or eMOF) table have to be converted to a wide format before joined to the occurrence and event data. 


```r
library(RJSONIO)
library(dplyr)
require(tidyr)

# Resolve endpoint URL from datasetID using the GBIF API
datasetID <- "78360224-5493-45fd-a9a0-c336557f09c3"
dataset <- RJSONIO::fromJSON(paste0("http://api.gbif.org/v1/dataset/",datasetID,"/endpoint"))
endpoint_url <- dataset[[1]]$url # extracting URL from API call result

# Download from dwc-a from IPT
tmp <- tempfile() # create temporary file for download
download.file(endpoint_url, tmp)
archive_files <- unzip(tmp, files = "NULL", list = T) 
unzip(tmp, list = F)

# extract occurrence, event and measurmentandfacts tables from dwc-a and join

occurrence <- read.table("occurrence.txt",sep="\t",header = T, stringsAsFactors = FALSE) %>% select(-id) # id field duplicates occurrenceID
event <- read.table("event.txt",sep="\t",header = T, stringsAsFactors = FALSE) %>% select(-id) # id field duplicates eventID
measurementorfact <- read.table("measurementorfact.txt",sep="\t",header = T, stringsAsFactors = FALSE) %>% rename(eventID=id) # NOTE! id field in a measurmentandfact table linked to the event core is an eventID

# Joint occurrences to events
df <- left_join(event,occurrence,by="eventID")

# create wide format from measurmentsandfacts and join
mof_wide <- measurementorfact %>% select(eventID,measurementValue,measurementType) %>% 
  spread(key=measurementType,
                   value=measurementValue)

df <- left_join(df,mof_wide)
```

